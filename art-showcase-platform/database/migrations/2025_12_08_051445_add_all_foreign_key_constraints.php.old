<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        echo "ğŸ”— Checking and adding foreign key constraints...\n";
        
        // 1. artworks.challenge_id â†’ challenges.id (jika belum ada)
        $this->addForeignKeyIfNotExists(
            'artworks', 
            'challenge_id', 
            'challenges', 
            'id', 
            'set null'
        );
        
        // 2. submissions.artwork_id â†’ artworks.id (SUDAH ADA - SKIP)
        echo "â© submissions.artwork_id constraint already exists (skipping)\n";
        
        // 3. likes.artwork_id â†’ artworks.id (jika belum ada)
        $this->addForeignKeyIfNotExists(
            'likes', 
            'artwork_id', 
            'artworks', 
            'id', 
            'cascade'
        );
        
        // 4. favorites.artwork_id â†’ artworks.id (jika belum ada)
        $this->addForeignKeyIfNotExists(
            'favorites', 
            'artwork_id', 
            'artworks', 
            'id', 
            'cascade'
        );
        
        // 5. comments.artwork_id â†’ artworks.id (jika belum ada)
        $this->addForeignKeyIfNotExists(
            'comments', 
            'artwork_id', 
            'artworks', 
            'id', 
            'cascade'
        );
        
        // 6. collection_artwork.artwork_id â†’ artworks.id (jika belum ada)
        $this->addForeignKeyIfNotExists(
            'collection_artwork', 
            'artwork_id', 
            'artworks', 
            'id', 
            'cascade'
        );
        
        echo "ğŸ‰ All foreign keys processed successfully!\n";
    }
    
    /**
     * Helper untuk menambah foreign key jika belum ada
     */
    private function addForeignKeyIfNotExists($table, $column, $referencedTable, $referencedColumn, $onDelete)
    {
        // Cek apakah table ada
        if (!Schema::hasTable($table) || !Schema::hasTable($referencedTable)) {
            echo "â© Table {$table} or {$referencedTable} doesn't exist (skipping)\n";
            return;
        }
        
        // Cek apakah foreign key sudah ada
        if ($this->foreignKeyExists($table, $column)) {
            echo "â© {$table}.{$column} constraint already exists (skipping)\n";
            return;
        }
        
        // Cek apakah kolom ada di table
        if (!Schema::hasColumn($table, $column)) {
            echo "â© Column {$column} doesn't exist in {$table} (skipping)\n";
            return;
        }
        
        // Tambah foreign key
        try {
            Schema::table($table, function (Blueprint $tableSchema) use ($column, $referencedTable, $referencedColumn, $onDelete) {
                $tableSchema->foreign($column)
                      ->references($referencedColumn)
                      ->on($referencedTable)
                      ->onDelete($onDelete);
            });
            echo "âœ… Added: {$table}.{$column} â†’ {$referencedTable}.{$referencedColumn}\n";
        } catch (\Exception $e) {
            echo "âŒ Failed to add {$table}.{$column}: " . $e->getMessage() . "\n";
        }
    }
    
    /**
     * Cek apakah foreign key sudah ada
     */
    private function foreignKeyExists($table, $column)
    {
        try {
            $constraints = DB::select("
                SELECT CONSTRAINT_NAME 
                FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE 
                WHERE TABLE_SCHEMA = DATABASE()
                AND TABLE_NAME = ?
                AND COLUMN_NAME = ?
                AND REFERENCED_TABLE_NAME IS NOT NULL
            ", [$table, $column]);
            
            return count($constraints) > 0;
            
        } catch (\Exception $e) {
            return false;
        }
    }

    public function down(): void
    {
        echo "ğŸ”— Dropping foreign key constraints...\n";
        
        // Hanya drop constraint yang kita tambahkan di up()
        // Karena submissions constraint sudah ada dari awal, jangan di-drop
        
        $this->dropForeignKeyIfExists('collection_artwork', 'artwork_id');
        $this->dropForeignKeyIfExists('comments', 'artwork_id');
        $this->dropForeignKeyIfExists('favorites', 'artwork_id');
        $this->dropForeignKeyIfExists('likes', 'artwork_id');
        $this->dropForeignKeyIfExists('artworks', 'challenge_id');
        
        echo "ğŸ‰ Foreign keys dropped successfully!\n";
    }
    
    private function dropForeignKeyIfExists($table, $column)
    {
        if (!Schema::hasTable($table) || !Schema::hasColumn($table, $column)) {
            return;
        }
        
        try {
            Schema::table($table, function (Blueprint $tableSchema) use ($column) {
                $tableSchema->dropForeignIfExists([$column]);
            });
            echo "âœ… Dropped: {$table}.{$column} foreign key\n";
        } catch (\Exception $e) {
            echo "âš ï¸ Could not drop {$table}.{$column}: " . $e->getMessage() . "\n";
        }
    }
};